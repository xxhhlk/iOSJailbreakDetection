name: Build Unsigned IPA for Jailbroken Devices

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Xcode ç‰ˆæœ¬
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
    
    - name: å®‰è£…è¾…åŠ©å·¥å…· (ldid)
      # ldid æ˜¯è¶Šç‹±å¼€å‘å¸¸ç”¨çš„ä¼ªç­¾åå·¥å…·ï¼Œé˜²æ­¢åº”ç”¨å› æƒé™é—®é¢˜é—ªé€€
      run: brew install ldid

    - name: æ¸…ç†æ„å»ºç›®å½•
      run: rm -rf build

    - name: ç”Ÿæˆå½’æ¡£ (Archive)
      # è¿™ä¸€æ­¥ä½ ä¹‹å‰æˆåŠŸäº†ï¼Œæˆ‘ä»¬ä¿æŒä¸å˜
      run: |
        xcodebuild archive \
          -project "iOSJailbreakDetection.xcodeproj" \
          -scheme "iOSJailbreakDetection" \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -archivePath "$PWD/build/iOSJailbreakDetection.xcarchive" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          AD_HOC_CODE_SIGNING_ALLOWED=YES

    - name: æ‰‹åŠ¨æ‰“åŒ… IPA (æ ¸å¿ƒä¿®å¤æ­¥éª¤)
      run: |
        cd build
        
        # 1. åˆ›å»ºæ ‡å‡†çš„ Payload ç›®å½•ç»“æ„
        mkdir Payload
        
        # 2. ä»å½’æ¡£æ–‡ä»¶ä¸­æå– .app åŒ…åˆ° Payload
        cp -r "iOSJailbreakDetection.xcarchive/Products/Applications/iOSJailbreakDetection.app" Payload/
        
        # 3. (å¯é€‰ä½†æ¨è) ä½¿ç”¨ ldid è¿›è¡Œä¼ªç­¾å
        # è¿™æœ‰åŠ©äºè§£å†³æŸäº›è¶Šç‹±ç¯å¢ƒä¸‹çš„ entitlements æƒé™é—®é¢˜
        # -S è¡¨ç¤ºä¼ªç­¾åï¼Œä¸å¸¦å‚æ•°è¡¨ç¤ºä»…è®¡ç®—å“ˆå¸Œ
        ldid -S Payload/iOSJailbreakDetection.app/iOSJailbreakDetection || true
        
        # 4. å‹ç¼©æˆ IPA æ–‡ä»¶
        zip -r iOSJailbreakDetection.ipa Payload
        
        # 5. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -rf Payload
        
        echo "ğŸ‰ IPA æ‰‹åŠ¨æ‰“åŒ…å®Œæˆï¼"
        ls -lh iOSJailbreakDetection.ipa

    - name: ä¸Šä¼  IPA æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: iOSJailbreakDetection-unsigned
        path: build/iOSJailbreakDetection.ipa
        retention-days: 30
