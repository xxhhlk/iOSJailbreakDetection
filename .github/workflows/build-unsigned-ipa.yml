name: Build Unsigned IPA for Jailbroken Devices

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: macos-14  # ä½¿ç”¨ macOS Sonoma (æœ€æ–°ç¨³å®šç‰ˆ)
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Xcode ç‰ˆæœ¬
      run: |
        # åˆ—å‡ºå¯ç”¨çš„ Xcode ç‰ˆæœ¬
        ls /Applications | grep Xcode
        # ä½¿ç”¨é»˜è®¤çš„æœ€æ–°ç‰ˆæœ¬ï¼ˆæ”¯æŒ iOS 17ï¼‰
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
    
    - name: åˆ›å»ºå¯¼å‡ºé…ç½®
      run: |
        cat > exportOptions.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>provisioningProfiles</key>
            <dict/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>teamID</key>
            <string></string>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <false/>
            <key>compileBitcode</key>
            <false/>
        </dict>
        </plist>
        EOF
        cat exportOptions.plist
    
    - name: æ¸…ç†æ„å»ºç›®å½•
      run: rm -rf build
    
    - name: æ„å»º iOS åº”ç”¨ (arm64)
      run: |
        # å…ˆ clean
        xcodebuild clean \
          -project "iOSJailbreakDetection.xcodeproj" \
          -scheme "iOSJailbreakDetection" \
          -configuration Release
        
        # æ„å»ºå½’æ¡£
        xcodebuild archive \
          -project "iOSJailbreakDetection.xcodeproj" \
          -scheme "iOSJailbreakDetection" \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -archivePath "$PWD/build/iOSJailbreakDetection.xcarchive" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ENABLE_BITCODE=NO
        
        # å¯¼å‡ºæœªç­¾åçš„ IPA
        xcodebuild -exportArchive \
          -archivePath "$PWD/build/iOSJailbreakDetection.xcarchive" \
          -exportOptionsPlist "$PWD/exportOptions.plist" \
          -exportPath "$PWD/build" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
    
    - name: éªŒè¯ç”Ÿæˆçš„ IPA
      run: |
        cd build
        ls -la
        echo "=== ç”Ÿæˆçš„ IPA æ–‡ä»¶ ==="
        find . -name "*.ipa" -type f
        echo "=== IPA æ–‡ä»¶ä¿¡æ¯ ==="
        for ipa in *.ipa; do
          echo "æ–‡ä»¶: $ipa"
          unzip -l "$ipa" | grep Payload | head -5
        done
    
    - name: ä¸Šä¼  IPA æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: iOSJailbreakDetection-unsigned
        path: build/*.ipa
        retention-days: 30
    
    - name: æ„å»ºå®Œæˆé€šçŸ¥
      run: |
        echo "âœ… æœªç­¾å IPA æ„å»ºå®Œæˆï¼"
        echo ""
        echo "ğŸ“± è¶Šç‹±è®¾å¤‡å®‰è£…æŒ‡å—ï¼š"
        echo "1. ç¡®ä¿è®¾å¤‡å·²è¶Šç‹±å¹¶å®‰è£… AppSync Unified"
        echo "2. ä»ä¸Šæ–¹ Artifacts ä¸‹è½½ IPA æ–‡ä»¶"
        echo "3. ä¼ è¾“åˆ°è®¾å¤‡ï¼ˆå¯ç”¨ iCloudã€AirDrop æˆ– SSHï¼‰"
        echo "4. ä½¿ç”¨ Filza æ–‡ä»¶ç®¡ç†å™¨æ‰“å¼€ IPA æ–‡ä»¶"
        echo "5. ç‚¹å‡»ã€Œå®‰è£…ã€æŒ‰é’®"
        echo "6. ç­‰å¾…å®‰è£…å®Œæˆï¼Œå›¾æ ‡å‡ºç°åœ¨ä¸»å±å¹•"
        echo ""
        echo "âš ï¸  æ³¨æ„ï¼šæ­¤ IPA æœªç­¾åï¼Œä»…èƒ½åœ¨è¶Šç‹±è®¾å¤‡ä¸Šå®‰è£…"
        echo "ğŸ“… æ„å»ºæ—¶é—´: $(date)"
